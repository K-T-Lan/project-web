<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMIC: The Co-Pilot Space</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" 
          href="tachcodecss.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* CSS c·ªßa b·∫°n ·ªü ƒë√¢y */
    </style>

    <!--link fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
</head>    
    <!-- STARFIELD BACKGROUND -->
    <div class="stars"></div>
    <div class="stars2"></div>
    
    <!-- NEW BACKGROUND ELEMENTS -->
     <!-- ƒê√¢y l√† ph·∫ßn t·∫°o background ƒë·ªông (n·ªÅn v≈© tr·ª•) cho website, kh√¥ng ph·∫£i n·ªôi dung ch√≠nh.-->
    <div class="nebula"></div>
    <div class="solar-system-container">
        <div class="sun"></div>
        <div class="orbit orbit-1">
            <div class="planet planet-1"></div>
        </div>
        <div class="orbit orbit-2">
            <div class="planet planet-2"></div>
        </div>
        <div class="orbit orbit-3">
            <div class="planet planet-3" style="top: 0; left: 50%; transform: translate(-50%, -50%);"></div>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
     <!--ƒê√¢y l√† m√†n h√¨nh ƒëƒÉng nh·∫≠p (LOGIN SCREEN) c·ªßa website-->
    <div id="login-screen">
        <div class="login-box">
            <img src="logo.png" class="logo">

            <div class="login-title">THE AIRLOCK</div>
            <p id="login-subtitle">Nh·∫≠p MSV ƒë·ªÉ truy c·∫≠p Cosmic Base.</p>
            
            <!-- CHANGED: Single input for MSV, Password hidden/auto -->
            <input type="text" id="auth-msv" class="login-input" placeholder="7 S·ªê CU·ªêI MSV (VD: 4043292)" autocomplete="off" maxlength="7">
            
            <button class="login-btn" onclick="handleAuth()" id="btn-auth-action">LOGIN (AUTO PASS)</button>
            <div id="login-error">L·ªói x√°c th·ª±c.</div>
            
            <div class="auth-switch" onclick="toggleAuthMode()">Ch∆∞a k√≠ch ho·∫°t MSV? <b>ƒêƒÉng k√Ω ngay</b></div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
<div id="notification-banner" style="display:none; position:fixed; top:20px; right:20px; z-index:2000; background:rgba(255,69,0,0.8); color:white; padding:15px; border-radius:10px; box-shadow:0 0 20px rgba(255,69,0,0.5); max-width:300px; font-size:14px;">
    <div id="banner-content"></div>
    <button onclick="document.getElementById('notification-banner').style.display='none'" style="position:absolute; top:5px; right:5px; background:none; border:none; color:white; cursor:pointer;">‚úï</button>
</div>


    <!--Khung ·ª©ng d·ª•ng ch√≠nh-->
    <div id="app-container" style="display: flex;">
        <!-- SIDEBAR --> <!-- C√°c tab, ch·ª©c nƒÉng c√≥ trong web ( v√≠ d·ª•: home, document, ....)-->
        <div class="sidebar">
            <div class="logo" onclick="location.reload()">C</div>

        <div class="nav-item active" onclick="switchTab('cabin', this)" title="Energy Cabin">
            <i class="fa-solid fa-circle-user"></i>
        </div>

        <div class="nav-item" onclick="switchTab('resources', this)" title="Resource Hub">
            <i class="fa-solid fa-folder-open"></i>
        </div>

        <div class="nav-item" onclick="switchTab('bridge', this)" title="The Brigade" id="bridge-nav">
            <i class="fa-solid fa-address-book"></i>
        </div>

        <div class="nav-item" onclick="switchTab('void', this)" title="The Void">
            <i class="fa-solid fa-comments"></i>
        </div>

        <div class="nav-item" onclick="switchTab('ranks', this)" title="Rank System">
            <i class="fa-solid fa-trophy"></i>
        </div>

        <div class="logout-btn" onclick="handleLogout()" title="Logout">
            <i class="fa-solid fa-right-from-bracket"></i>
        </div>
</div>

        <!-- MAIN CONTENT -->
         <!--üëâ V√πng n·ªôi dung trung t√¢m c·ªßa ·ª©ng d·ª•ng To√†n b·ªô c√°c ‚Äúm√†n h√¨nh‚Äù (view) nh∆∞ Cabin, Resource Hub‚Ä¶ ƒë·ªÅu n·∫±m trong ƒë√¢y.-->
        <div class="main-content">
            
            <!-- CABIN VIEW -->
            <div id="cabin" class="view-section active">
                <h1 id="cabin-title">Energy Cabin</h1>
                <div class="subtitle">Welcome back, <span id="welcome-name">Commander</span>. Systems Online.</div>

                <div class="cabin-grid">
                    <!-- Profile -->
                    <div class="profile-card">
                        <div id="user-avatar-frame" class="avatar-container avatar-frame basic">
                            <div class="avatar-img" id="user-avatar-img"></div>
                        </div>
                        <div class="user-name" id="user-display-name">Loading...</div>
                        <div class="rank-title" id="user-rank-title">CONNECTING...</div>
                        <div class="tier-tag" id="user-tier-tag" style="display:inline-block; margin-bottom:10px;">Checking ID</div>
                        
                        <div><p>Energy Core Status</p></div>
                        <div class="energy-bar-container">
                            <div class="energy-bar-fill" id="energy-bar"></div>
                        </div>
                        <div style="margin-top:5px; font-size:12px; color:var(--neon-teal);"><span id="energy-text">0</span> / MAX</div>
                    </div>

                    <!-- Stats Matrix -->
                    <div>
                        <h3>Matrix Stats Analysis</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-val" id="stat-focus">0h</div>
                                <div class="stat-label">Focus Time (Navigator)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-val" id="stat-upload">0</div>
                                <div class="stat-label">Uploads (Guardian)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-val" id="stat-interact">0</div>
                                <div class="stat-label">Interactions (Diplomat)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-val" id="stat-online">1 Day</div>
                                <div class="stat-label">Online (Voyager)</div>
                            </div>
                        </div>
                        
                        <div id="quote-box">
                            <!-- Dynamic Quote inserted by JS -->
                        </div>

                        <!-- ADMIN PANEL (Hidden for normal users) -->
                        <div id="admin-panel" class="admin-panel">
                            <h3>
                                üõ°Ô∏è COMMAND CENTER (ADMIN)
                            </h3>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <span>Qu·∫£n l√Ω th√†nh vi√™n The Brigade</span>
                                <input type="text" id="admin-search" placeholder="T√¨m MSV...">
                            </div>
                            <div class = "table">
                                <table class="crew-table" id="crew-list">
                                    <!-- Populated by JS -->
                                    <tr><td colspan="3">Loading crew data...</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESOURCE HUB VIEW -->
            <div id="resources" class="view-section">
                <!-- Main List View -->
                <div id="resource-hub-main">
                    <h1>Resource Hub</h1>
                    <div class="subtitle">Kho tri th·ª©c t·∫≠p trung. ƒê√£ ƒë·ªìng b·ªô 100%.</div>

                   <div style="display:flex; gap:10px; margin-bottom:20px;">
    
            <div class="autocomplete-wrapper">
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="T√¨m ki·∫øm t√†i li·ªáu / M√¥n h·ªçc..."
                    autocomplete="off"
                    oninput="handleSearchInput(this)"
                    onfocus="handleSearchInput(this)"
                >

                <div id="search-suggestion-box"></div>
            </div>

             <button class="btn-primary" onclick="openUploadModal()">Upload Document</button>
</div>

<div class="resource-list" id="resource-list-container">
    <div style="text-align:center; padding: 20px; color: #666;">
        <i>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Cosmic Cloud...</i>
    </div>
</div>
                        <!-- Items will be injected here via JS -->
                        <div style="text-align:center; padding: 20px; color: #666;">
                            <i>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Cosmic Cloud...</i>
                        </div>
                    </div>
                </div>

                <!-- SPLIT VIEW (Initially Hidden) -->
                <div id="split-view-container" style="display:none;">
                    <!-- LEFT: Doc Viewer -->
                    <div class="split-left">
                        <div class="doc-viewer-header">
                            <div style="display:flex; align-items:center; gap:10px; overflow:hidden;">
                                <button class="btn-back" onclick="closeSplitView()">‚Üê Back</button>
                                <span id="doc-title">Document Title</span>
                            </div>
                            <div style="display:flex; align-items:center;">
                                <button class="btn-primary">Download PDF</button>
                                <button id="btn-delete-current-doc" class="btn-delete-doc" onclick="deleteCurrentDocument()">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>
                        <div class="doc-content-placeholder">
                             <iframe id="doc-iframe" class="doc-iframe" src=""></iframe>
                             <div id="doc-placeholder-msg">
                                <div style="font-size: 40px; margin-bottom: 20px;">üìÑ</div>
                                <p id="doc-msg-text">File n√†y l√† t√†i li·ªáu ngo√†i h·ªá th·ªëng.</p>
                                <a href="#" target="_blank" id="external-link-btn" style="color:var(--neon-teal);">M·ªü li√™n k·∫øt g·ªëc</a>
                             </div>
                        </div>
                    </div>

                    <!-- RIGHT: SOS Chat -->
                    <div class="split-right">
                        <div class="chat-header">
                            <span>SOS Channel</span>
                            <button class="btn-sos-trigger" onclick="triggerSOS()">üö® SIGNAL SOS</button>
                        </div>
                        <div class="chat-messages" id="chat-box">
                            <div class="chat-msg msg-system">System: Connected to Context Chat.</div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" placeholder="Type message..." id="chat-input-field">
                            <button class="btn-send" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            
            <!-- UPLOAD MODAL (Hidden) -->
            <div id="upload-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content">
                    <h2 class="modal-title">UPLOAD T√ÄI LI·ªÜU</h2>
                    <input type="text" id="up-title" class="modal-input" placeholder="T√™n t√†i li·ªáu (VD: ƒê·ªÅ c∆∞∆°ng Kinh t·∫ø)">
            <div class="autocomplete-wrapper">
                <input type="text" id="up-category" class="modal-input" 
                    placeholder="Nh·∫≠p t√™n m√¥n h·ªçc (VD: MKT21A...)" 
                    autocomplete="off" 
                    oninput="handleCategoryInput(this)" 
                    onfocus="handleCategoryInput(this)">
                <div id="suggestion-box"></div>
                 </div>                    
                    <!-- NEW: INPUT URL OPTION -->
                    <input type="text" id="up-url" class="modal-input" placeholder="Ho·∫∑c d√°n link Google Drive/PDF online...">

                    <div class="file-drop-area" onclick="document.getElementById('up-file').click()">
                        <div id = "üìÇ">üìÇ</div>
                        <span>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c Click ƒë·ªÉ ch·ªçn</span>
                        <input type="file" id="up-file" style="display:none" onchange="handleFileSelect(this)">
                        <div id="file-name-display" style="margin-top:10px; color:var(--neon-teal); font-size:12px;"></div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-fill" id="up-progress"></div>
                    </div>
                    <div id="progress-text">Uploading... 0%</div>

                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button onclick="closeUploadModal()" class="btn-back">H·ªßy</button>
                        <button onclick="submitUpload()" class="btn-primary">X√°c nh·∫≠n Upload</button>
                        </div>
                    </div>
                </div>

            <!-- ROLE EDIT MODAL (Admin Only) -->
            <div id="role-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content" style="width:350px;">
                    <h3>PH√ÇN QUY·ªÄN TRUY C·∫¨P</h3>
                    <p id="role-target-name">Target: ...</p>
                    
                    <div class="role-option">
                        <input type="checkbox" id="role-admin"> <label for="role-admin">Admin (To√†n quy·ªÅn)</label>
                    </div>
                    <div class="role-option">
                        <input type="checkbox" id="role-tester"> <label for="role-tester">Tester (G·ª≠i ƒë·ªÅ xu·∫•t)</label>
                    </div>
                    <div class="role-option">
                        <input type="checkbox" id="role-op"> <label for="role-op">Operation (Duy·ªát t√†i li·ªáu)</label>
                    </div>
                    <div class="role-option">
                        <input type="checkbox" id="role-mkt"> <label for="role-mkt">Marketing (G·ª≠i th√¥ng b√°o)</label>
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button onclick="document.getElementById('role-modal').style.display='none'" class="btn-back">H·ªßy</button>
                        <button onclick="submitRoleChange()" class="btn-primary" style="background:var(--neon-gold); color:black;">L∆∞u Quy·ªÅn</button>
                    </div>
                </div>
            </div>

            <!-- BRIDGE VIEW (Access Restricted) -->
            <div id="bridge" class = "view-section">
                <h1>The Brigade</h1>
                <div class="subtitle">Trung t√¢m ch·ªâ huy & ƒêi·ªÅu h√†nh chi·∫øn d·ªãch</div>

                <div id="bridge-locked">
                    <h1>üîí</h1>
                    <h2>ACCESS DENIED</h2>
                    <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o khu v·ª±c n√†y.<br>Ch·ªâ d√†nh cho c√°c sƒ© quan ƒëi·ªÅu h√†nh.</p>
                </div>

                <div id="bridge-content">
                    
                    <!-- DYNAMIC ROLE VIEWS -->
                    <div class = "role-views">
                        
                        <!-- LEFT COLUMN: Role Actions -->
                        <div class = "role-card">
                            <!-- TESTER VIEW -->
                            <div class="role-card tester" id="panel-tester" style="display:none;">
                                <h3>üõ†Ô∏è TESTER STATION</h3>
                                <p>G·ª≠i ƒë·ªÅ xu·∫•t s·ª≠a ƒë·ªïi h·ªá th·ªëng.</p>
                                <textarea id="proposal-text" placeholder="M√¥ t·∫£ ƒë·ªÅ xu·∫•t..."></textarea>
                                <button onclick="sendProposal()" class="btn-primary" style="margin-top:10px;">G·ª≠i Admin</button>
                            </div>

                            <!-- MARKETING VIEW -->
                            <div class="role-card mkt" id="panel-mkt" style="display:none;">
                                <h3>üì¢ BROADCAST STATION</h3>
                                <p>So·∫°n th√¥ng b√°o to√†n c·ª•c (C·∫ßn duy·ªát).</p>
                                <input id="broadcast-msg" type="text" placeholder="N·ªôi dung th√¥ng b√°o...">
                                <button onclick="requestBroadcast()" class="btn-primary">G·ª≠i Duy·ªát</button>
                            </div>

                            <!-- OPERATION VIEW -->
                            <div class="role-card op" id="panel-op" style="display:none;">
                                <h3>üìã OPS CENTER</h3>
                                <p>Duy·ªát t√†i li·ªáu & B√°o c√°o quy tr√¨nh.</p>
                                <div style="background:#111; padding:10px; font-size:12px;">
                       
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Admin & Radar -->
                        <div class = "role-card">
                            <!-- ADMIN VIEW -->
                            <div class="role-card admin" id="panel-admin" style="display:none;">
                                <h3>üëë HIGH COMMAND</h3>
                                <div style="margin-bottom:15px;">
                                    <h4>INBOX (ƒê·ªÄ XU·∫§T & TH√îNG B√ÅO)</h4>
                                    <div id="admin-inbox">
                                        <!-- Items via JS -->
                                        <div><i>H√≤m th∆∞ tr·ªëng...</i></div>
                                    </div>
                                </div>
                            </div>

                            <!-- RADAR (Always visible for authorized) -->
                            <div class = "radar">
                                <h3>LIVE RADAR</h3>
                                <div class="radar-container" style="height:250px;">
                                    <div class="radar-circle" id="radar-screen" style="width:200px; height:200px;">
                                        <div class="radar-sweep"></div>
                                        <div class="radar-dot" style="top: 30%; left: 40%;" title="Active"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RANK SYSTEM VIEW (Simplified) -->
            <div id="ranks" class="view-section">
                <h1>Cosmic Ranks</h1>
                <div class="subtitle">H·ªá th·ªëng ph√¢n c·∫•p t·ª± ƒë·ªông</div>
                
                <div style="margin-top: 50px; text-align: center; color: #aaa;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ü§ñ</div>
                    <p style="font-weight: bold;">SYSTEM AUTO-PILOT ENABLED</p>
                    <p>
                        H·ªá th·ªëng x·∫øp h·∫°ng hi·ªán ƒëang ho·∫°t ƒë·ªông ng·∫ßm (Implant Mode).<br>
                        M·ªçi ch·ªâ s·ªë Navigator, Guardian v√† Diplomat c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ghi nh·∫≠n v√† chuy·ªÉn h√≥a th√†nh Energy Points.
                    </p>
                    <br>
                    <p id = "againclick">
                        Ki·ªÉm tra c·∫•p ƒë·ªô hi·ªán t·∫°i c·ªßa b·∫°n t·∫°i <b onclick="switchTab('cabin', document.querySelector('.nav-item.active'))">Energy Cabin</b>
                    </p>
                </div>
            </div>

            <!-- VOID VIEW (Chat Interface) -->
            <div id="void" class="view-section" style="height: 100%;">
                <div class="void-container">
                    <div class="void-header">
                        <div><span class="void-status-dot"></span>ENCRYPTED CHANNEL: THE VOID (ONLINE)</div>
                        <div id="void-user-identity">CONNECTING...</div>
                    </div>
                    
                    <div class="void-messages-area" id="void-messages">
                        <!-- Messages will be injected here -->
                        <div style="text-align: center; color: #444; margin-top: 20px; font-style: italic;">
                            -- Connecting to Cosmic Network... --
                        </div>
                    </div>

                    <div class="void-input-area">
                        <span> ü§ì </span>
                        <input type="text" class="void-input" id="void-input-field" placeholder="Nh·∫≠p t√≠n hi·ªáu... (Enter ƒë·ªÉ g·ª≠i)" autocomplete="off">
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- FIREBASE MODULE SCRIPT -->
    <script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
// Th√™m d√≤ng n√†y v√†o c·ª•m import:
import { logEvent, setUserProperties } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        // Firebase Configuration (From User)
        const firebaseConfig = {
            apiKey: "AIzaSyC4LY3lNNIMhsmC5fuJAG3ejABe3cWj41M",
            authDomain: "resource-9a362.firebaseapp.com",
            projectId: "resource-9a362",
            storageBucket: "resource-9a362.firebasestorage.app",
            messagingSenderId: "64359181492",
            appId: "1:64359181492:web:10d0622bd941451b5a7be1",
            measurementId: "G-TQ84LTSXD6"
        };

        // Initialize Firebase with try-catch
        let app, analytics, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase & Auth Initialized!");
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("L·ªói k·∫øt n·ªëi h·ªá th·ªëng! Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.");
        }


// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://xvwxryquxiphepyqatbd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2d3hyeXF1eGlwaGVweXFhdGJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDcwMDEsImV4cCI6MjA4MjI4MzAwMX0.H5i14vJWotgWcTos6znXFHnUQXulKjpvR4gU4979VFA';
const supabase = createClient(supabaseUrl, supabaseKey);
console.log("Supabase Initialized!");  // ƒê·ªÉ test console
// --- C·∫§U TR√öC RANK DATA ---
// --- C·∫§U TR√öC RANK DATA (FINAL NAMES) ---
const RANK_SYSTEM = {
    // 8 M·ªëc ƒëi·ªÉm t∆∞∆°ng ·ª©ng t·ª´ Lv1 -> Lv8
    thresholds: [0, 200, 1000, 2000, 4000, 6000, 8000, 10000],
    
    // B·∫£ng t√™n danh hi·ªáu theo 4 tr·ª• c·ªôt (User th∆∞·ªùng)
    titles: {
        // C·ªôt 1: NAVIGATOR (Diligence - Focus)
        navigator: ["Probe", "Rover", "Lander", "Orbiter", "Ranger", "Pioneer", "Voyager", "Horizon"],
        
        // C·ªôt 2: GUARDIAN (Contribution - Upload)
        guardian:  ["Dust", "Meteor", "Asteroid", "Moon", "Planet", "Star", "Nebula", "Galaxy"],
        
        // C·ªôt 3: DIPLOMAT (Social - Chat)
        diplomat:  ["Ping", "Echo", "Wave", "Pulse", "Beam", "Signal", "Resonance", "Spectrum"],
        
        // C·ªôt 4: VOYAGER (Enthusiastic - Online)
        voyager:   ["Second", "Minute", "Hour", "Day", "Year", "Century", "Millennium", "Eternity"]
    },

    // Danh hi·ªáu Genesis (CH·ªà D√ÄNH CHO STAFF)
    genesis: {
        op: "Sanctuary",     // Operation
        tester: "Symphony",  // Tester
        mkt: "Origin"        // Marketing
    }
};
// --- DANH S√ÅCH M√îN H·ªåC (DATA T·ª™ ·∫¢NH) ---
const SUBJECT_LIST = [
    "MGT01A - Qu·∫£n tr·ªã h·ªçc",
    "MKT21A - Marketing",
    "MGT12A - H√†nh vi t·ªï ch·ª©c",
    "FIN02A - T√†i ch√≠nh doanh nghi·ªáp",
    "FIN17A - Ng√¢n h√†ng th∆∞∆°ng m·∫°i",
    "MIS08A - Ph√¢n t√≠ch thi·∫øt k·∫ø h·ªá th·ªëng",
    "IS60A - Qu·∫£n l√Ω d·ª± √°n c√¥ng ngh·ªá th√¥ng tin",
    "IS54A - Tr√≠ tu·ªá nh√¢n t·∫°o",
    "GRA50A - Th·ª±c t·∫≠p chuy√™n ng√†nh",
    "IS51A - L·∫≠p tr√¨nh Web v·ªõi Php v√† MySQL",
    "IS49A - Ph√¢n t√≠ch nghi·ªáp v·ª• (BA)",
    "IS24A - Kho d·ªØ li·ªáu v√† kinh doanh th√¥ng minh",
    "IS34A - H·ªá th·ªëng ho·∫°ch ƒë·ªãnh t√†i nguy√™n doanh nghi·ªáp",
    "IS55A - C√¥ng ngh·ªá d·ªãch v·ª• t√†i ch√≠nh",
    "MIS06A - C√°c h·ªá th·ªëng th√¥ng tin trong ng√¢n h√†ng",
    "IS56A - C√¥ng ngh·ªá ng√¢n h√†ng s·ªë",
    "GRA90A - T·ªët nghi·ªáp (8 t√≠n ch·ªâ)",
    "ƒê·ªì √°n t·ªët nghi·ªáp",
    "SPT03A - Gi√°o d·ª•c th·ªÉ ch·∫•t II (B√≥ng r·ªï)",
    "SPT04A - Gi√°o d·ª•c th·ªÉ ch·∫•t III (B√≥ng chuy·ªÅn)",
    "SPT05A - Gi√°o d·ª•c th·ªÉ ch·∫•t IV (C·∫ßu l√¥ng)",
    "SPT06A - Gi√°o d·ª•c th·ªÉ ch·∫•t V (Khi√™u v≈©)",
    "ENG04A - Ti·∫øng Anh IV",
    "IS20A - Nh·∫≠p m√¥n h·ªá th·ªëng th√¥ng tin",
    "IS22A - C∆° s·ªü l·∫≠p tr√¨nh",
    "IS21A - C∆° s·ªü d·ªØ li·ªáu",
    "ACT01A - Nguy√™n l√Ω k·∫ø to√°n",
    "ECO09A - Kinh t·∫ø h·ªçc",
    "IS07A - C·∫•u tr√∫c d·ªØ li·ªáu v√† gi·∫£i thu·∫≠t",
    "IS53A - Thi·∫øt k·∫ø c∆° s·ªü d·ªØ li·ªáu",
    "MAT05A - To√°n r·ªùi r·∫°c",
    "MIS07A - H·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu",
    "IS35A - Th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠",
    "IS19A - Thi·∫øt k·∫ø Web",
    "MIS02A - H·ªá th·ªëng th√¥ng tin qu·∫£n l√Ω",
    "IS06A - M·∫°ng v√† truy·ªÅn th√¥ng",
    "IS25A - L·∫≠p tr√¨nh .NET",
    "IS23A - Khai ph√° v√† ph√¢n t√≠ch d·ªØ li·ªáu",
    "PLT07A - Tri·∫øt h·ªçc M√°c - L√™nin",
    "PLT08A - Kinh t·∫ø ch√≠nh tr·ªã M√°c - L√™nin",
    "PLT09A - Ch·ªß nghƒ©a x√£ h·ªôi khoa h·ªçc",
    "PLT10A - L·ªãch s·ª≠ ƒê·∫£ng C·ªông s·∫£n Vi·ªát Nam",
    "PLT06A - T∆∞ t∆∞·ªüng H·ªì Ch√≠ Minh",
    "ENG01A - Ti·∫øng Anh I",
    "ENG02A - Ti·∫øng Anh II",
    "ENG03A - Ti·∫øng Anh III",
    "IS52A - NƒÉng l·ª±c s·ªë ·ª©ng d·ª•ng",
    "LAW01A - Ph√°p lu·∫≠t ƒë·∫°i c∆∞∆°ng",
    "MAT15A - To√°n d√†nh cho kinh t·∫ø",
    "MAT14A - X√°c su·∫•t v√† th·ªëng k√™",
    "BUS20A - Giao ti·∫øp trong kinh doanh",
    "MGT36A - ƒê·ªïi m·ªõi s√°ng t·∫°o v√† kh·ªüi nghi·ªáp",
    "SPT07A - Gi√°o d·ª•c qu·ªëc ph√≤ng v√† An ninh",
    "SPT02A - Gi√°o d·ª•c th·ªÉ ch·∫•t I (ƒê·∫°i c∆∞∆°ng)"
];

// H√†m x·ª≠ l√Ω khi nh·∫≠p li·ªáu (Filter & Show Suggestion)
window.handleCategoryInput = function(input) {
    const val = input.value.toLowerCase();
    const box = document.getElementById('suggestion-box');
    
    // N·∫øu tr·ªëng th√¨ hi·ªÉn th·ªã 5 m√¥n ƒë·∫ßu ti√™n (ho·∫∑c list tr·ªëng t√πy b·∫°n)
    // ·ªû ƒë√¢y m√¨nh ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô list l·ªçc ƒë∆∞·ª£c
    const filtered = SUBJECT_LIST.filter(sub => sub.toLowerCase().includes(val));

    if (filtered.length === 0) {
        box.style.display = 'none';
        return;
    }

    // T·∫°o HTML cho list
    let html = '';
    filtered.forEach(sub => {
        // Highlight t·ª´ kh√≥a t√¨m ki·∫øm
        const regex = new RegExp(`(${val})`, 'gi');
        const highlighted = sub.replace(regex, '<strong>$1</strong>');
        html += `<div class="suggestion-item" onclick="selectCategory('${sub}')">${highlighted}</div>`;
    });

    box.innerHTML = html;
    box.style.display = 'block';
};

// H√†m ch·ªçn m√¥n h·ªçc t·ª´ list
window.selectCategory = function(value) {
    document.getElementById('up-category').value = value;
    document.getElementById('suggestion-box').style.display = 'none';
};

// ·∫®n box khi click ra ngo√†i
document.addEventListener('click', function(e) {
    const wrapper = document.querySelector('.autocomplete-wrapper');
    if (wrapper && !wrapper.contains(e.target)) {
        document.getElementById('suggestion-box').style.display = 'none';
    }
});   
     // GLOBAL VARS attached to window for HTML access
        window.currentUserRank = "UNKNOWN";
        window.currentUserName = "Unknown Pilot";
        window.currentUserRoles = []; // Stores roles: ['admin', 'tester', 'op', 'mkt']
        window.currentMsv = "";
        window.voidIdentity = "";
        window.isSOSActive = false;
        window.isRegisterMode = false; // Toggle login/register
        window.targetEditUid = null; // For admin role editing
        window.currentDocId = null; // ID of doc being viewed
// --- MODULE TELEMETRY (TRACKING SYSTEM) ---
window.docStartTime = 0; // Bi·∫øn ƒë·∫øm gi·ªù ƒë·ªçc

// H√†m b·∫Øn event chung
window.trackTelemetry = function(eventName, params = {}) {
    if (!analytics) return; // Ch∆∞a init xong th√¨ b·ªè qua

    const now = new Date();
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    // T·ª± ƒë·ªông l·∫•y gi·ªù & th·ª© ƒë·ªÉ v·∫Ω Heatmap
    const timeContext = {
        hour_of_day: now.getHours(),      // 0-23
        day_of_week: days[now.getDay()],  // Th·ª©
        timestamp_iso: now.toISOString()
    };

    // G·ªôp data v√† b·∫Øn l√™n Google
    const finalParams = { ...timeContext, ...params };
    
    try {
        logEvent(analytics, eventName, finalParams);
        // B·∫≠t d√≤ng d∆∞·ªõi n·∫øu mu·ªën soi log ƒë·ªÉ test, ch·∫°y th·∫≠t th√¨ t·∫Øt ƒëi cho ƒë·ª° r·ªëi
        // console.log(`üì° SENT [${eventName}]`, finalParams); 
    } catch (e) {
        console.warn("Telemetry Error:", e);
    }
};

// H√†m ƒë·ªãnh danh User (G·ªçi khi Login xong)
window.identifyUserForTracking = function(profile) {
    if (!analytics) return;
    
    // G·∫Øn nh√£n User n√†y vƒ©nh vi·ªÖn
    setUserProperties(analytics, {
        user_msv: profile.msv,
        user_rank: profile.rank,
        user_role: (profile.roles || []).join(','),
        last_login_timestamp: new Date().toISOString()
    });
    
    // B·∫Øn event Login
    window.trackTelemetry('login', { method: 'msv_auth' });
};
        // --- AUTH & PROFILE LOGIC ---

        // Listen for Auth State Changes
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User logged in:", user.uid);
                    await window.ensureUserProfile(user);
                    window.enterApp();
                } else {
                    console.log("No user logged in");
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('login-screen').style.opacity = '1';
                    document.getElementById('app-container').style.display = 'none';
                }
            });
        }

        window.toggleAuthMode = function() {
            window.isRegisterMode = !window.isRegisterMode;
            const title = document.querySelector('.login-title');
            const sub = document.getElementById('login-subtitle');
            const btn = document.getElementById('btn-auth-action');
            const switchText = document.querySelector('.auth-switch');

            if (window.isRegisterMode) {
                title.innerText = "K√çCH HO·∫†T MSV";
                sub.innerText = "Thi·∫øt l·∫≠p m·∫≠t kh·∫©u cho MSV l·∫ßn ƒë·∫ßu.";
                btn.innerText = "REGISTER (AUTO PASS)";
                switchText.innerHTML = "ƒê√£ c√≥ m·∫≠t kh·∫©u? <b>ƒêƒÉng nh·∫≠p ngay</b>";
            } else {
                title.innerText = "THE AIRLOCK";
                sub.innerText = "Nh·∫≠p MSV ƒë·ªÉ truy c·∫≠p Cosmic Base.";
                btn.innerText = "LOGIN (AUTO PASS)";
                switchText.innerHTML = "Ch∆∞a k√≠ch ho·∫°t MSV? <b>ƒêƒÉng k√Ω ngay</b>";
            }
        };

        window.handleAuth = async function() {
            const msvInput = document.getElementById('auth-msv').value.trim();
            const pass = msvInput; // PASSWORD IS SAME AS MSV
            const errorMsg = document.getElementById('login-error');

            if (!msvInput) { errorMsg.innerText = "Vui l√≤ng nh·∫≠p MSV."; errorMsg.style.display = 'block'; return; }
            if (msvInput.length !== 7 || isNaN(msvInput)) { errorMsg.innerText = "MSV ph·∫£i bao g·ªìm ƒë√∫ng 7 ch·ªØ s·ªë."; errorMsg.style.display = 'block'; return; }

            const email = msvInput + "@cosmic.local"; 

            try {
                if (window.isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (error) {
                console.error(error);
                let msg = "L·ªói h·ªá th·ªëng: " + error.message;
                if(error.code === 'auth/email-already-in-use') msg = "MSV n√†y ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t r·ªìi.";
                if(error.code === 'auth/wrong-password') msg = "Sai m·∫≠t kh·∫©u (N·∫øu ch∆∞a t·∫°o, h√£y b·∫•m ƒêƒÉng k√Ω).";
                if(error.code === 'auth/user-not-found') msg = "MSV ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t.";
                if(error.code === 'auth/invalid-email') msg = "ƒê·ªãnh d·∫°ng MSV kh√¥ng h·ª£p l·ªá.";
                errorMsg.innerText = msg;
                errorMsg.style.display = 'block';
                document.querySelector('.login-box').style.animation = 'shake 0.3s';
                setTimeout(() => { document.querySelector('.login-box').style.animation = 'none'; }, 300);
            }
        };

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                location.reload(); 
            } catch (error) { console.error("Logout error", error); }
        };

        window.ensureUserProfile = async function(user) {
            const userRef = doc(db, "users", user.uid);
            let userSnap;
            try { userSnap = await getDoc(userRef); } catch (e) { console.error("Error reading profile:", e); return; }
            
            const msv = user.email.split('@')[0];

            if (userSnap.exists()) {
                // --- PROFILE ƒê√É T·ªíN T·∫†I ---
                let data = userSnap.data();

                // [FIX QUAN TR·ªåNG] FORCE UPDATE CHO ADMIN
                // N·∫øu l√† 4043292 m√† ch∆∞a c√≥ quy·ªÅn admin -> C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
                if (msv === '4043292') {
                    const currentRoles = data.roles || [];
                    // Ki·ªÉm tra xem ƒë√£ full quy·ªÅn ch∆∞a
                    if (!currentRoles.includes('admin') || data.rank !== 'SUPERNOVA') {
                        console.log("Detected Commander ID. Elevating privileges...");
                        
                        const adminUpdates = {
                            rank: "SUPERNOVA",
                            energy: 99999,
                            displayName: "Commander Ho√†n", // C·∫≠p nh·∫≠t l·∫°i t√™n chu·∫©n
                            roles: ['admin', 'tester', 'op', 'mkt'] // Full quy·ªÅn
                        };

                        try {
                            await updateDoc(userRef, adminUpdates);
                            // G·ªôp data m·ªõi v√†o data c≈© ƒë·ªÉ hi·ªÉn th·ªã ngay ko c·∫ßn F5
                            data = { ...data, ...adminUpdates };
                            alert("üì° H·ªÜ TH·ªêNG: ƒê√£ nh·∫≠n di·ªán Commander. Quy·ªÅn Admin ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c!");
                        } catch(err) {
                            console.error("L·ªói c·∫•p quy·ªÅn admin:", err);
                        }
                    }
                }

                window.loadUserProfile(data);
            } else {
                // --- PROFILE M·ªöI (CH∆ØA T·ª™NG ƒêƒÇNG NH·∫¨P) ---
                
                let initialRank = "Space Debris";
                let initialEnergy = 0;
                let initialName = "Cadet " + msv;
                let initialRoles = ['user'];
                
                // Logic Admin cho ng∆∞·ªùi m·ªõi
                if (msv === '4043292') {
                    initialRank = "SUPERNOVA";
                    initialEnergy = 99999;
                    initialName = "Commander Ho√†n"; 
                    initialRoles = ['admin', 'tester', 'op', 'mkt'];
                }

                const defaultProfile = {
                    msv: msv,
                    displayName: initialName,
                    email: user.email,
                    rank: initialRank,
                    energy: initialEnergy,
                    roles: initialRoles,
                    stats: { focus: 0, upload: 0, interact: 0, online: 1 },
                    joinedAt: serverTimestamp()
                };
                await setDoc(userRef, defaultProfile);
                window.loadUserProfile(defaultProfile);
            }
        };
// --- H√ÄM HIGH COMMAND - ƒê√É FIX SYNTAX HO√ÄN TO√ÄN ---
  window.setupHighCommand = function() {
    const inbox = document.getElementById('admin-inbox');
    if (!inbox) {
        console.error("Kh√¥ng t√¨m th·∫•y #admin-inbox");
        return;
    }
    inbox.innerHTML = '<div style="color:#00FFC2; text-align:center; padding:20px;">ƒêang t·∫£i inbox...</div>';
    console.log("High Command: B·∫Øt ƒë·∫ßu load...");
    
    // Proposals
    const proposalsQ = query(collection(db, "proposals"), where("status", "==", "unread"), orderBy("createdAt", "desc"));
    onSnapshot(proposalsQ, (snap) => {
    console.log("Proposals: ", snap.size, "docs");

    let html = '<h4 style="color:#00FFC2;">ƒê·ªÅ xu·∫•t Tester</h4>';

    if (snap.empty) {
        html += '<div style="color:#888;">Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t m·ªõi.</div>';
    } else {
        snap.forEach(d => {
            const data = d.data();
            const createdAt = data.createdAt?.toDate?.();
            const timeString = createdAt ? createdAt.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' }) : '';

            html += `
                <div class="proposal-box">
                    ${data.content}<br>
                    <small>${data.sender} ‚Äì ${timeString}</small><br>
                    <button onclick="markAsRead('${d.id}', 'proposals')"
                        style="background:#333; color:white; border:1px solid #555; padding:2px 5px; font-size:10px; cursor:pointer; margin-top:5px;">
                        Mark Read
                    </button>
                </div>
            `;
        });
    }
    // G·∫Øn l·∫°i n·ªôi dung m·ªõi, kh√¥ng b·ªã l·∫∑p
    document.getElementById('admin-inbox').innerHTML = html + '<hr style="border-color:#444;">';
});

    
    // Broadcasts
    const broadcastsQ = query(collection(db, "broadcasts"), where("status", "==", "pending"), orderBy("createdAt", "desc"));
    onSnapshot(broadcastsQ, (snap) => {
        console.log("Broadcasts: ", snap.size, "docs");
        let html = '<h4 style="color:#FF00FF;">Y√™u c·∫ßu Broadcast</h4>';
        if (snap.empty) {
            html += '<div style="color:#888;">Kh√¥ng c√≥ y√™u c·∫ßu m·ªõi.</div>';
        } else {
            snap.forEach(d => {
                const data = d.data();
                html += `<div style="padding:10px; border-left:4px solid #FF00FF; margin-bottom:10px;">
                    ${data.message}<br><small>${data.sender}</small>
                    <div style="margin-top:5px;">
                        <button onclick="approveBroadcast('${d.id}', '${data.message.replace(/'/g, "\\'")}')" style="background:var(--neon-teal); color:black; border:none; padding:2px 5px; font-size:10px; cursor:pointer;">Approve</button>
                        <button onclick="rejectBroadcast('${d.id}')" style="background:#FF4500; color:white; border:none; padding:2px 5px; font-size:10px; cursor:pointer; margin-left:5px;">Reject</button>
                    </div>
                </div>`;
            });
        }
        updateInbox(html);
    });
    
    function updateInbox(newHtml) {
        // ƒê·ªÉ tr√°nh flicker, append m·ªõi ho·∫∑c replace n·∫øu c·∫ßn
        const current = inbox.innerHTML;
        if (current.includes('ƒêang t·∫£i')) {
            inbox.innerHTML = '';
        }
        inbox.innerHTML += newHtml; // Ho·∫∑c logic merge t·ªët h∆°n n·∫øu c·∫ßn
    }
};
      window.loadUserProfile = function(data) {
    if (!data) data = {};
    const displayName = data.displayName || "Unknown Pilot";
    const rank = data.rank || "Space Debris";
    const energy = typeof data.energy === 'number' ? data.energy : 0;
    const roles = data.roles || ['user'];

    // 1. C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c & UI c∆° b·∫£n
    window.currentUserName = displayName;
    window.currentUserRank = rank.toUpperCase();
    window.currentUserRoles = roles;
    window.currentMsv = data.msv;

    document.getElementById('user-display-name').innerText = displayName;
    document.getElementById('welcome-name').innerText = displayName;

    // --- 2. LOGIC T√çNH TO√ÅN RANK & TIER (M·ªöI) ---
    const rankTitle = document.getElementById('user-rank-title');
    const tierTag = document.getElementById('user-tier-tag');
    const avatarFrame = document.getElementById('user-avatar-frame');
    const quoteBox = document.getElementById('quote-box');
    const energyBar = document.getElementById('energy-bar');

    let displayRank = "Probe"; // M·∫∑c ƒë·ªãnh
    let tierClass = "rank-standard";
    let tagClass = "tag-standard";
    let frameClass = "basic";
    let tierName = "Tier 1"; 
    let quoteHtml = "";

    // A. ADMIN -> TIER 5: ULTIMATE (SUPERNOVA)
    if (roles.includes('admin')) {
        displayRank = "SUPERNOVA";   
        tierName = "ULTIMATE"; 
        tierClass = "rank-ultimate"; 
        tagClass = "tag-ultimate";
        frameClass = "supernova";    
        quoteHtml = `<h4 style="color: #FF4500;">üî• THE COMMANDER</h4><p>Quy·ªÅn l·ª±c t·ªëi th∆∞·ª£ng.</p>`;
    }
    // B. STAFF -> SPECIAL: GENESIS (SANCTUARY/SYMPHONY/ORIGIN)
    else if (roles.some(r => ['op', 'tester', 'mkt'].includes(r))) {
        tierClass = "rank-genesis"; 
        tagClass = "tag-genesis";
        frameClass = "supernova";   
        tierName = "GENESIS"; 

        if (roles.includes('op')) {
            displayRank = "SANCTUARY"; 
            quoteHtml = `<h4 style="color: #DC143C;">üõ°Ô∏è SANCTUARY</h4><p>Th√°nh ƒë·ªãa v·∫≠n h√†nh.</p>`;
        } else if (roles.includes('tester')) {
            displayRank = "SYMPHONY"; 
            quoteHtml = `<h4 style="color: #DC143C;">üéπ SYMPHONY</h4><p>S·ª± ph·ªëi h·ª£p ho√†n h·∫£o.</p>`;
        } else if (roles.includes('mkt')) {
            displayRank = "ORIGIN"; 
            quoteHtml = `<h4 style="color: #DC143C;">üì¢ ORIGIN</h4><p>Kh·ªüi ngu·ªìn lan t·ªèa.</p>`;
        } else {
            displayRank = "GENESIS"; 
            quoteHtml = `<h4 style="color: #DC143C;">ü©∏ GENESIS STAFF</h4><p>Th√†nh vi√™n s√°ng th·∫ø.</p>`;
        }
    } 
    // C. USER -> TIER 1 - 4 (Theo 4 h·ªá: Navigator, Guardian, Diplomat, Voyager)
    else {
        // C.1: T√≠nh Level hi·ªán t·∫°i (0 -> 7 t∆∞∆°ng ·ª©ng Lv 1 -> 8)
        let levelIndex = 0;
        for (let i = 0; i < RANK_SYSTEM.thresholds.length; i++) {
            if (energy >= RANK_SYSTEM.thresholds[i]) levelIndex = i;
        }
        const currentLevel = levelIndex + 1;

        // C.2: X√°c ƒë·ªãnh H·ªá (Archetype) d·ª±a tr√™n ch·ªâ s·ªë cao nh·∫•t
        const s = data.stats || { focus: 0, upload: 0, interact: 0, online: 0 };
        let maxStat = 'focus';
        let maxVal = s.focus || 0;
        let archetypeName = "NAVIGATOR"; // M·∫∑c ƒë·ªãnh

        // So s√°nh t√¨m ch·ªâ s·ªë max
        if ((s.upload || 0) > maxVal) { maxStat = 'upload'; maxVal = s.upload; archetypeName = "GUARDIAN"; }
        if ((s.interact || 0) > maxVal) { maxStat = 'interact'; maxVal = s.interact; archetypeName = "DIPLOMAT"; }
        // Online l√† ch·ªâ s·ªë ph·ª•, n·∫øu c√°c c√°i kia = 0 ho·∫∑c online c·ª±c cao th√¨ m·ªõi t√≠nh
        if (maxVal === 0 && (s.online || 0) > 0) { maxStat = 'online'; archetypeName = "VOYAGER"; }

        // L·∫•y t√™n Rank t·ª´ b·∫£ng RANK_SYSTEM
        if (maxStat === 'upload') displayRank = RANK_SYSTEM.titles.guardian[levelIndex];
        else if (maxStat === 'interact') displayRank = RANK_SYSTEM.titles.diplomat[levelIndex];
        else if (maxStat === 'online') displayRank = RANK_SYSTEM.titles.voyager[levelIndex];
        else displayRank = RANK_SYSTEM.titles.navigator[levelIndex]; 

        displayRank = displayRank.toUpperCase();

        // C.3: X√°c ƒë·ªãnh Visual Tier (Hi·ªáu ·ª©ng)
        if (currentLevel <= 5) {
            // Lv 1-5: Standard
            tierClass = "rank-standard";
            tagClass = "tag-standard";
            frameClass = "basic";
            tierName = `Tier 1 ‚Ä¢ Lv.${currentLevel}`;
        } else if (currentLevel === 6) {
            // Lv 6: Neon Pulse
            tierClass = "rank-neon";
            tagClass = "tag-neon";
            frameClass = "basic"; 
            tierName = "NEON PULSE (Tier 2)";
        } else if (currentLevel === 7) {
            // Lv 7: Nebula Flow
            tierClass = "rank-nebula";
            tagClass = "tag-nebula";
            frameClass = "supernova"; // B·∫Øt ƒë·∫ßu d√πng khung ƒë·∫πp
            tierName = "NEBULA FLOW (Tier 3)";
        } else { 
            // Lv 8 (Max): Horizon
            tierClass = "rank-horizon";
            tagClass = "tag-horizon";
            frameClass = "supernova";
            tierName = "HORIZON (Tier 4)";
        }

        // Th√¥ng tin XP cho level ti·∫øp theo
        const nextXp = RANK_SYSTEM.thresholds[levelIndex + 1];
        const xpText = nextXp ? `Next: ${nextXp} XP` : 'MAX LEVEL';
        
        quoteHtml = `<h4 style="color: #aaa;">${displayRank}</h4><p style="font-size:12px; color:#666;">${archetypeName} Class ‚Ä¢ ${xpText}</p>`;
    }

    // --- 3. RENDER UI ---
    rankTitle.className = "rank-title " + tierClass;
    rankTitle.innerText = displayRank; 
    
    tierTag.className = "tier-tag " + tagClass;
    tierTag.innerText = tierName;

    avatarFrame.className = "avatar-container avatar-frame " + frameClass;
    quoteBox.innerHTML = quoteHtml;
    
    document.getElementById('energy-text').innerText = energy;
    
    // --- 4. THANH NƒÇNG L∆Ø·ª¢NG (ENERGY BAR) ---
    if (roles.includes('admin') || tierClass === "rank-genesis" || energy >= 10000) {
        // Admin, Staff ho·∫∑c Max Level -> Full c√¢y
        energyBar.style.width = "100%";
    } else {
        // User ƒëang c√†y -> T√≠nh % trong c·∫•p hi·ªán t·∫°i
        let currentBase = 0;
        let nextTarget = 200;
        
        // T√¨m m·ªëc hi·ªán t·∫°i
        for (let i = 0; i < RANK_SYSTEM.thresholds.length; i++) {
            if (energy >= RANK_SYSTEM.thresholds[i]) {
                currentBase = RANK_SYSTEM.thresholds[i];
                nextTarget = RANK_SYSTEM.thresholds[i+1] || 10000;
            }
        }
        
        // T√≠nh to√°n
        let range = nextTarget - currentBase;
        let gained = energy - currentBase;
        let pct = (range > 0) ? (gained / range) * 100 : 100;
        energyBar.style.width = Math.max(5, pct) + "%"; // T·ªëi thi·ªÉu 5% ƒë·ªÉ nh√¨n th·∫•y v·∫°ch
    }

    // --- 5. KH·ªûI T·∫†O C√ÅC MODULE KH√ÅC ---
    
    // Admin Panel
    if (roles.includes('admin')) {
        document.getElementById('admin-panel').style.display = 'block';
        window.loadCrewList();
    }

    // Ops Center (Cho Admin & Op)
    if (roles.includes('admin') || roles.includes('op')) {
        const panelOp = document.getElementById('panel-op');
        if(panelOp) panelOp.style.display = 'block'; 
        window.setupOpsCenter(); 
    }

    // Chat & Resource Hub
    window.initVoidChat();
    window.initResourceHub();
    window.setupHighCommand();
window.identifyUserForTracking(data);
};

        window.enterApp = function() {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
            }, 500);
        };
window.showNotificationBanner = function(msg) {
    const banner = document.getElementById('notification-banner');
    const content = document.getElementById('banner-content');
    if (banner && content) {
        content.innerHTML = msg;
        banner.style.display = 'block';
        // Auto hide after 10s
        setTimeout(() => { banner.style.display = 'none'; }, 10000);
    }
};
  window.approveBroadcast = async function(id, msg) {
    if (!confirm("Approve v√† broadcast th√¥ng b√°o n√†y?")) return;
    try {
        await updateDoc(doc(db, "broadcasts", id), { status: 'approved' });
        const broadcastMsg = `TH√îNG B√ÅO T·ª™ HIGH COMMAND: ${msg}`;
        await addDoc(collection(db, "void_messages"), {
            identity: "üì¢ COSMIC SIGNAL",
            text: broadcastMsg,
            createdAt: serverTimestamp()
        });
        // Show in banner immediately
        window.showNotificationBanner(broadcastMsg);
        alert("‚úÖ Approved v√† broadcasted!");
    } catch (e) {
        alert("L·ªói: " + e.message);
    }
};

// C·∫≠p nh·∫≠t appendVoidMessage ƒë·ªÉ check broadcast
window.appendVoidMessage = function(identity, text, isMe) {
    const chatBox = document.getElementById('void-messages');
    const row = document.createElement('div');
    row.className = `void-msg-row ${isMe ? 'me' : ''}`;
    const idDiv = document.createElement('div'); idDiv.className = 'void-identity'; idDiv.innerText = identity;
    const contentDiv = document.createElement('div'); contentDiv.className = 'void-content'; contentDiv.innerText = text;
    row.appendChild(idDiv); row.appendChild(contentDiv);
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // If broadcast, show in banner
    if (identity === "üì¢ COSMIC SIGNAL") {
        window.showNotificationBanner(text);
    }
};

window.rejectBroadcast = async function(id) {
    if (!confirm("Reject y√™u c·∫ßu n√†y?")) return;
    try {
        await updateDoc(doc(db, "broadcasts", id), { status: 'rejected' });
        alert("‚ùå Rejected!");
    } catch (e) {
        alert("L·ªói: " + e.message);
    }
};// H√†m mark proposal as read
window.markAsRead = async function(id, collectionName) {
    try {
        await updateDoc(doc(db, collectionName, id), { status: 'read' });
        alert("‚úÖ Marked as read!");
    } catch (e) {
        alert("L·ªói: " + e.message);
    }
};
        window.switchTab = function(tabId, element) {
            // CHECK ACCESS FOR BRIDGE
            if (tabId === 'bridge') {
                const hasAccess = window.currentUserRoles.some(r => ['admin','tester','op','mkt'].includes(r));
                document.getElementById('bridge-locked').style.display = hasAccess ? 'none' : 'block';
                document.getElementById('bridge-content').style.display = hasAccess ? 'block' : 'none';
                
                if (hasAccess) {
                    // Show panels based on role
                    document.getElementById('panel-admin').style.display = window.currentUserRoles.includes('admin') ? 'block' : 'none';
                    document.getElementById('panel-tester').style.display = window.currentUserRoles.includes('tester') ? 'block' : 'none';
                    document.getElementById('panel-op').style.display = window.currentUserRoles.includes('op') ? 'block' : 'none';
                    document.getElementById('panel-mkt').style.display = window.currentUserRoles.includes('mkt') ? 'block' : 'none';
                }
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
        };

        // --- ADMIN: CREW MANAGEMENT LOGIC ---
        window.loadCrewList = function() {
            // CHANGED: Increased limit to 100 and ordered by MSV
            const q = query(collection(db, "users"), orderBy("msv", "asc"), limit(100)); 
            onSnapshot(q, (snapshot) => {
                const table = document.getElementById('crew-list');
                let html = `<tr><th>MSV</th><th>T√™n</th><th>Vai tr√≤</th><th>Action</th></tr>`;
                
                // Add counter
                const total = snapshot.size;
                document.querySelector('#admin-panel h3').innerHTML = `üõ°Ô∏è COMMAND CENTER (ADMIN) - <span style="font-size:12px; color:#888;">Total: ${total} members</span>`;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const roles = d.roles || ['user'];
                    let roleBadges = '';
                    if(roles.includes('admin')) roleBadges += `<span class="role-badge role-admin">ADMIN</span>`;
                    if(roles.includes('tester')) roleBadges += `<span class="role-badge role-tester">TESTER</span>`;
                    if(roles.includes('op')) roleBadges += `<span class="role-badge role-op">OP</span>`;
                    if(roles.includes('mkt')) roleBadges += `<span class="role-badge role-mkt">MKT</span>`;
                    
                    // Highlight Admin Row
                    const rowStyle = d.msv === '4043292' ? 'background:rgba(255,215,0,0.1);' : '';

                    html += `
                        <tr style="${rowStyle}">
                            <td>${d.msv}</td>
                            <td>${d.displayName}</td>
                            <td>${roleBadges}</td>
                            <td><button onclick="openRoleModal('${doc.id}', '${d.displayName}', '${roles.join(',')}')" style="background:#333; color:white; border:1px solid #555; cursor:pointer;">Edit</button></td>
                        </tr>
                    `;
                });
                table.innerHTML = html;
            });
        };

        window.openRoleModal = function(uid, name, rolesStr) {
            window.targetEditUid = uid;
            document.getElementById('role-target-name').innerText = "Target: " + name;
            
            const roles = rolesStr.split(',');
            document.getElementById('role-admin').checked = roles.includes('admin');
            document.getElementById('role-tester').checked = roles.includes('tester');
            document.getElementById('role-op').checked = roles.includes('op');
            document.getElementById('role-mkt').checked = roles.includes('mkt');
            
            document.getElementById('role-modal').style.display = 'flex';
        };

        window.submitRoleChange = async function() {
            if (!window.targetEditUid) return;
            
            const newRoles = ['user']; // Always base user
            if(document.getElementById('role-admin').checked) newRoles.push('admin');
            if(document.getElementById('role-tester').checked) newRoles.push('tester');
            if(document.getElementById('role-op').checked) newRoles.push('op');
            if(document.getElementById('role-mkt').checked) newRoles.push('mkt');

            try {
                await updateDoc(doc(db, "users", window.targetEditUid), {
                    roles: newRoles
                });
                document.getElementById('role-modal').style.display = 'none';
                alert("ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
            } catch(e) {
                console.error(e);
                alert("L·ªói khi c·∫≠p nh·∫≠t quy·ªÅn: " + e.message);
            }
        };

        // --- ROLE ACTIONS (Mockup Logic for Demo) ---
      window.sendProposal = async function() {
    const txt = document.getElementById('proposal-text').value.trim();
    if (!txt) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë·ªÅ xu·∫•t!");
    
    try {
        await addDoc(collection(db, "proposals"), {
            content: txt,
            sender: window.currentUserName,
            senderUid: auth.currentUser.uid,
            status: 'unread',
            createdAt: serverTimestamp()
        });
        document.getElementById('proposal-text').value = '';
        alert("üõ†Ô∏è ƒê·ªÅ xu·∫•t ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi High Command!");
    } catch (e) {
        console.error("L·ªói g·ª≠i proposal:", e);
        alert("L·ªói k·∫øt n·ªëi: " + e.message);
    }
};

      window.requestBroadcast = async function() {
    const txt = document.getElementById('broadcast-msg').value.trim();
    if (!txt) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o!");
    
    try {
        await addDoc(collection(db, "broadcasts"), {
            message: txt,
            sender: window.currentUserName,
            senderUid: auth.currentUser.uid,
            status: 'pending',
            createdAt: serverTimestamp()
        });
        document.getElementById('broadcast-msg').value = '';
        alert("üì¢ Y√™u c·∫ßu ph√°t s√≥ng ƒë√£ ƒë∆∞·ª£c g·ª≠i duy·ªát!");
    } catch (e) {
        console.error("L·ªói g·ª≠i broadcast:", e);
        alert("L·ªói k·∫øt n·ªëi: " + e.message);
    }
};

        // ... [Gi·ªØ nguy√™n c√°c h√†m openSplitView, closeSplitView, initVoidChat, etc.] ...
        window.openSplitView = function(docName, fileUrl, docId, uploaderName) {
// Th√™m v√†o ƒë·∫ßu h√†m:
window.docStartTime = Date.now(); // B·∫Øt ƒë·∫ßu b·∫•m gi·ªù
window.trackTelemetry('view_document', { 
    doc_title: docName, 
    doc_id: docId,
    uploader_name: uploaderName
});
            document.getElementById('resource-hub-main').style.display = 'none';
            document.getElementById('split-view-container').style.display = 'flex';
            document.getElementById('doc-title').innerText = docName;
            window.currentDocId = docId;
            
            // --- DELETE BUTTON LOGIC ---
            const btnDelete = document.getElementById('btn-delete-current-doc');
            // Show if Admin OR if current user is the uploader
            if (window.currentUserRoles.includes('admin') || window.currentUserName === uploaderName) {
                btnDelete.style.display = 'block';
            } else {
                btnDelete.style.display = 'none';
            }

           const iframe = document.getElementById('doc-iframe');
    const placeholderMsg = document.getElementById('doc-placeholder-msg');
    const msgText = document.getElementById('doc-msg-text');
    const extLinkBtn = document.getElementById('external-link-btn');
    
    if (fileUrl && (fileUrl.includes('supabase.co') || fileUrl.toLowerCase().endsWith('.pdf'))) {
        // Supabase or PDF: Use Google Viewer for reliable preview
        iframe.style.display = 'block';
        placeholderMsg.style.display = 'none';
        const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
        iframe.src = googleViewerUrl;
    } else if (fileUrl && fileUrl.startsWith('http')) {
        // External link (e.g., Google Drive)
        iframe.style.display = 'none';
        placeholderMsg.style.display = 'block';
        msgText.innerText = "T√†i li·ªáu n√†y l√† li√™n k·∫øt ngo√†i (Google Drive/Web).";
        extLinkBtn.href = fileUrl;
        extLinkBtn.innerText = "M·ªü t√†i li·ªáu t·∫°i tab m·ªõi ‚Üó";
        extLinkBtn.style.display = 'inline-block';
    } else {
        // No valid URL or deprecated blob
        iframe.style.display = 'none';
        placeholderMsg.style.display = 'block';
        msgText.innerText = "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu ho·∫∑c preview kh√¥ng h·ªó tr·ª£.";
        extLinkBtn.style.display = 'none';
    }
};

        window.closeSplitView = function() {
// Th√™m v√†o ƒë·∫ßu h√†m:
if (window.docStartTime > 0) {
    const duration = (Date.now() - window.docStartTime) / 1000;
    if (duration > 5) { // ƒê·ªçc tr√™n 5s m·ªõi t√≠nh
        window.trackTelemetry('read_completed', { 
            duration_seconds: Math.round(duration) 
        });
    }
    window.docStartTime = 0;
}
            document.getElementById('split-view-container').style.display = 'none';
            document.getElementById('resource-hub-main').style.display = 'block';
            document.getElementById('doc-iframe').src = "";
            window.currentDocId = null;
        };
        
        window.deleteCurrentDocument = async function() {
            if(!window.currentDocId) return;
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i li·ªáu n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) return;
            
            try {
                await deleteDoc(doc(db, "resources", window.currentDocId));
                alert("ƒê√£ x√≥a t√†i li·ªáu.");
                window.closeSplitView();
            } catch(e) {
                console.error(e);
                alert("L·ªói khi x√≥a: " + e.message);
            }
        };

        window.initVoidChat = function() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            window.voidIdentity = `${window.currentUserRank}#${randomNum}`;
            document.getElementById('void-user-identity').innerText = "ID: " + window.voidIdentity;

            const q = query(collection(db, "void_messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('void-messages');
                chatBox.innerHTML = '<div style="text-align: center; color: #444; margin-top: 20px; font-style: italic;">-- D·ªØ li·ªáu ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Cosmic Cloud --</div>';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = data.identity === window.voidIdentity;
                    window.appendVoidMessage(data.identity, data.text, isMe);
                });
            });
        };

        // H√†m th√™m tin nh·∫Øn v√†o chat, k√®m ng√†y gi·ªù
        window.appendVoidMessage = function(identity, text, isMe) {
            const chatBox = document.getElementById('void-messages');
            const row = document.createElement('div');
            row.className = `void-msg-row ${isMe ? 'me' : ''}`;

            const idDiv = document.createElement('div');
            idDiv.className = 'void-identity';
            idDiv.innerText = identity;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'void-content';

            const now = new Date();
            const dateString = now.toLocaleDateString('vi-VN');
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const timestamp = `${dateString} ${timeString}`;

            contentDiv.innerHTML = `
                <p>${text}</p>
                <span class="timestamp">${timestamp}</span>
            `;

            row.appendChild(idDiv);
            row.appendChild(contentDiv);
            chatBox.appendChild(row);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        window.sendVoidMessage = async function() {
            const input = document.getElementById('void-input-field');
            const text = input.value.trim();
    
    // Ch·ªâ x·ª≠ l√Ω khi c√≥ n·ªôi dung (tr√°nh spam tin r·ªóng)
    if (text) {
        try {
            // 1. G·ª≠i tin nh·∫Øn l√™n Firestore
            await addDoc(collection(db, "void_messages"), { 
                identity: window.voidIdentity, 
                text: text, 
                createdAt: serverTimestamp() 
            });
            
            // 2. D·ªçn d·∫πp √¥ input
            input.value = '';

            // 3. [TRACKING] B·∫Øn t√≠n hi·ªáu l√™n GA4
            // Logic: G·ª≠i th√†nh c√¥ng v√†o Database -> M·ªõi b·∫Øn Tracking
            window.trackTelemetry('send_message', { channel: 'void_main' });
            
        } catch (e) { 
            console.error(e); 
            alert("L·ªói k·∫øt n·ªëi!"); 
        }
    }
};



        window.openUploadModal = function() {

            document.getElementById('upload-modal').style.display = 'flex';

        };



        window.closeUploadModal = function() {

            document.getElementById('upload-modal').style.display = 'none';

            document.getElementById('up-title').value = '';

            document.getElementById('up-category').value = '';

            document.getElementById('up-file').value = '';

            document.getElementById('up-url').value = '';

            document.getElementById('file-name-display').innerText = '';

            document.querySelector('.progress-container').style.display = 'none';

            document.getElementById('progress-text').style.display = 'none';

            document.getElementById('up-progress').style.width = '0%';

        };

        window.handleFileSelect = function(input) {
            if(input.files && input.files[0]) {
                document.getElementById('file-name-display').innerText = "Selected: " + input.files[0].name;
            }
        };

window.submitUpload = async function() {
    const title = document.getElementById('up-title').value.trim();
    const category = document.getElementById('up-category').value.trim();
    const fileInput = document.getElementById('up-file');
    const urlInput = document.getElementById('up-url').value.trim();

    if (!title || !category || (!fileInput.files.length && !urlInput)) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ch·ªçn File ho·∫∑c nh·∫≠p Link!");
        return;
    }

    const progressContainer = document.querySelector('.progress-container');
    const progressFill = document.getElementById('up-progress');
    const progressText = document.getElementById('progress-text');
    progressContainer.style.display = 'block';
    progressText.style.display = 'block';
    progressText.innerText = "Preparing...";

    try {
        let fileUrl = "";
        let fileName = "";

        if (urlInput) {
            // Use external URL directly (no upload)
            fileUrl = urlInput;
            fileName = "External Link";
            progressFill.style.width = '100%';
            progressText.innerText = "Processing external link... 100%";
        } else if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 50 * 1024 * 1024) {  // Limit 50MB
                throw new Error("File qu√° l·ªõn (>50MB). Vui l√≤ng d√πng Link Drive.");
            }

            // Clean filename
            const cleanName = file.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9.-]/g, '_');
            const path = `${Date.now()}_${cleanName}`;  // Unique path

            progressText.innerText = "Uploading to Supabase...";
            progressFill.style.width = '20%';  // Simulate start

            // Upload to Supabase
            const { data, error } = await supabase.storage.from('COSMIC file').upload(path, file);
            if (error) throw error;

            // Get public URL
            const { data: publicData } = supabase.storage.from('COSMIC file').getPublicUrl(path);
            fileUrl = publicData.publicUrl;
            fileName = file.name;

            progressFill.style.width = '100%';
            progressText.innerText = "Upload complete! 100%";
        }

        // Save to Firestore
        await addDoc(collection(db, "resources"), {
            title,
            category,
            fileName,
            fileUrl,
            uploader: window.currentUserName,
            uploaderUid: auth.currentUser.uid,
            status: 'pending', 
            createdAt: serverTimestamp()
        });

        // --- [NEW] TRACKING & XP SECTION (N·∫±m trong TRY) ---
        
        // 1. B·∫Øn Tracking (Guardian Activity)
        window.trackTelemetry('upload_document', { 
            doc_title: title, 
            doc_category: category,
            status: 'pending' 
        });

        // 2. C·ªông ƒëi·ªÉm GUARDIAN (+10 Energy)
        window.addEnergy(10, 'guardian');

        // 3. Th√¥ng b√°o & ƒê√≥ng Modal
        alert("Upload th√†nh c√¥ng! T√†i li·ªáu ƒëang ch·ªù duy·ªát.");
        window.closeUploadModal();

    } catch (e) {
        console.error("Upload error:", e);
        alert("L·ªói: " + e.message);
        progressContainer.style.display = 'none';
        progressText.style.display = 'none';
    }
};
    // --- B∆Ø·ªöC 1: S·ª¨A LOGIC HI·ªÇN TH·ªä T·∫†I RESOURCE HUB ---
    window.initResourceHub = function() {
    // V·∫´n l·∫•y c√°c t√†i li·ªáu m·ªõi nh·∫•t
    const q = query(collection(db, "resources"), orderBy("createdAt", "desc"), limit(50));
    
    onSnapshot(q, (snapshot) => {
        const listContainer = document.getElementById('resource-list-container');
        if (snapshot.empty) { 
            listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color: #666;">Ch∆∞a c√≥ t√†i li·ªáu n√†o.</div>'; 
            return; 
        }

        let dynamicItemsHTML = "";
        
        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
        const currentUid = auth.currentUser ? auth.currentUser.uid : "";
        const userRoles = window.currentUserRoles || [];
        // Ki·ªÉm tra xem user c√≥ quy·ªÅn qu·∫£n l√Ω kh√¥ng (Admin ho·∫∑c Op)
        const isStaff = userRoles.includes('admin') || userRoles.includes('op');

        snapshot.forEach((doc) => {
            const data = doc.data();
            const status = data.status || 'pending'; // M·∫∑c ƒë·ªãnh l√† pending
            
            // LOGIC QUY·∫æT ƒê·ªäNH HI·ªÇN TH·ªä:
            let isVisible = false;
            let statusBadge = "";

            if (status === 'approved') {
                // 1. N·∫øu ƒë√£ duy·ªát -> Ai c≈©ng th·∫•y
                isVisible = true;
            } else if (status === 'pending') {
                // 2. N·∫øu ƒëang ch·ªù -> Ch·ªâ Admin, Ops ho·∫∑c Ch√≠nh ch·ªß m·ªõi th·∫•y
                if (isStaff || data.uploaderUid === currentUid) {
                    isVisible = true;
                    statusBadge = `<span class="res-tag" style="background:#FF8C00; color:#000;">‚è≥ PENDING</span>`;
                }
            }

            if (isVisible) {
                const safeTitle = data.title.replace(/'/g, "\\'");
                const safeUrl = (data.fileUrl || "").replace(/'/g, "\\'");
                const uploader = data.uploader || "Unknown";
                
                dynamicItemsHTML += `
                    <div class="resource-item" onclick="openSplitView('${safeTitle}', '${safeUrl}', '${doc.id}', '${uploader}')">
                        <div style="display:flex; align-items:center;">
                            <div class="res-icon">üìÑ</div>
                            <div class="res-info">
                                <h3>${data.title} ${statusBadge}</h3>
                                <p>${data.category} ‚Ä¢ Upload b·ªüi: <b>${uploader}</b></p>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #888;">Click to view</div>
                    </div>
                `;
            }
        });
        
        if (dynamicItemsHTML === "") {
             listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color: #666;">Kh√¥ng c√≥ t√†i li·ªáu kh·∫£ d·ª•ng cho b·∫°n.</div>';
        } else {
            listContainer.innerHTML = dynamicItemsHTML;
        }
    });
};
        window.triggerSOS = async function() {
            const radar = document.getElementById('radar-screen');
            const sosCount = document.getElementById('sos-count');
            const radarStatus = document.getElementById('radar-status');
            const btn = document.querySelector('.btn-sos-trigger');
            const chatBox = document.getElementById('chat-box');
            
            if (!window.isSOSActive) {
                window.isSOSActive = true;
                if(btn) { btn.innerHTML = "üö´ CANCEL SOS"; btn.classList.add('active'); }
                if(chatBox) { chatBox.innerHTML += `<div class="chat-msg msg-system" style="border-color: #FF4500; color:#FF4500;">üö® BROADCASTING SOS SIGNAL...</div>`; }
                if(radar) {
                    const top = Math.floor(Math.random() * 60) + 20 + '%'; const left = Math.floor(Math.random() * 60) + 20 + '%';
                    radar.innerHTML += `<div class="radar-dot-new" id="active-sos-dot" style="top:${top}; left:${left};"></div>`;
                    radarStatus.innerText = "WARNING: DISTRESS SIGNAL ACTIVE!"; radarStatus.style.color = "#FF4500";
                    // let currentCases = parseInt(sosCount.innerText); sosCount.innerText = (currentCases + 1) + " Cases";
                }
                try { await addDoc(collection(db, "sos_signals"), { user: window.voidIdentity, status: "ACTIVE", timestamp: serverTimestamp() }); } catch(e) {}
            } else {
                window.isSOSActive = false;
                if(btn) { btn.innerHTML = "üö® SIGNAL SOS"; btn.classList.remove('active'); }
                if(chatBox) { chatBox.innerHTML += `<div class="chat-msg msg-system" style="border-color: #00FFC2; color:#00FFC2;">‚úÖ SOS SIGNAL CANCELLED.</div>`; }
                if(radar) {
                    const dot = document.getElementById('active-sos-dot'); if(dot) dot.remove();
                    radarStatus.innerText = "Scanning Sector 7..."; radarStatus.style.color = "#888";
                    // let currentCases = parseInt(sosCount.innerText); sosCount.innerText = Math.max(0, currentCases - 1) + " Cases";
                }
            }
        };

   window.sendMessage = function() {
    const input = document.getElementById('chat-input-field');
    const chatBox = document.getElementById('chat-box');
    const text = input.value.trim();

    // Ch·ªâ ch·∫°y khi c√≥ n·ªôi dung tin nh·∫Øn th·ª±c s·ª±
    if(text) {
        // 1. X·ª≠ l√Ω UI
        chatBox.innerHTML += `<div class="chat-msg msg-me">${text}</div>`;
        input.value = ''; 
        chatBox.scrollTop = chatBox.scrollHeight;

        // 2. X·ª≠ l√Ω logic SOS
        if(text.toLowerCase().includes('sos')) { 
            setTimeout(() => { 
                if (!window.isSOSActive) { 
                    window.triggerSOS(); 
                } else { 
                    chatBox.innerHTML += `<div class="chat-msg msg-system">SOS signal is already active! Rescue team alerted.</div>`; 
                } 
            }, 500); 
        }

        // --- [NEW] TRACKING & XP SECTION (ƒê·∫∑t trong IF m·ªõi ƒë√∫ng) ---
        
        // 3. B·∫Øn Tracking
        window.trackTelemetry('send_message', { channel: 'sos_chat' });

        // 4. C·ªông ƒëi·ªÉm DIPLOMAT
        // Chat k√™nh SOS ƒë∆∞·ª£c
}
};
// --- B∆Ø·ªöC 2: LOGIC OPS CENTER (DUY·ªÜT B√ÄI & TH√îNG B√ÅO) ---

// H√†m kh·ªüi ch·∫°y Ops Center (Ch·ªâ g·ªçi khi user l√† Admin/Op)
window.setupOpsCenter = function() {
    const opsPanel = document.getElementById('panel-op');
    if (!opsPanel) return;

    // 1. V·∫Ω l·∫°i giao di·ªán Ops Panel ƒë·ªÉ ch·ª©a danh s√°ch ch·ªù
    opsPanel.innerHTML = `
        <h3>üìã OPS CENTER</h3>
        <p style="font-size:12px; color:#aaa; margin-bottom:10px;">Trung t√¢m ki·ªÉm so√°t t√†i li·ªáu.</p>
        
        <div style="border-top: 1px solid #333; padding-top:10px;">
            <h4 style="color:#FF8C00; font-size:12px; margin-bottom:10px;">H√ÄNG CH·ªú DUY·ªÜT (PENDING QUEUE)</h4>
            <div id="ops-pending-list" style="background:#000; padding:10px; height:180px; overflow-y:auto; border:1px solid #333; border-radius:5px;">
                <div style="text-align:center; color:#666; font-style:italic; padding-top:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
    `;

    // 2. L·∫Øng nghe realtime c√°c file c√≥ status = 'pending'
    const q = query(collection(db, "resources"), where("status", "==", "pending"), orderBy("createdAt", "desc"));
    
    onSnapshot(q, (snapshot) => {
        const container = document.getElementById('ops-pending-list');
        const bridgeNav = document.getElementById('bridge-nav'); // Icon Radar ·ªü Sidebar
        
        if (snapshot.empty) {
            container.innerHTML = '<div style="text-align:center; color:#666; font-size:12px; padding-top:20px;">Kh√¥ng c√≥ t√†i li·ªáu ch·ªù duy·ªát.</div>';
            // T·∫Øt ƒë√®n b√°o hi·ªáu
            if(bridgeNav) {
                bridgeNav.style.border = "none";
                bridgeNav.style.boxShadow = "none";
            }
        } else {
            // C√ì FILE M·ªöI: 
            // a. B·∫≠t ƒë√®n b√°o hi·ªáu (vi·ªÅn ƒë·ªè) ·ªü Sidebar
            if(bridgeNav) {
                bridgeNav.style.border = "1px solid #FF4500";
                bridgeNav.style.boxShadow = "0 0 10px #FF4500";
            }
            // b. Hi·ªán Banner th√¥ng b√°o
            window.showNotificationBanner(`‚ö†Ô∏è OPS ALERT: C√≥ ${snapshot.size} t√†i li·ªáu c·∫ßn duy·ªát!`);

            // c. Render danh s√°ch
            let html = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const safeTitle = data.title.replace(/'/g, "\\'");
                const safeUrl = (data.fileUrl || "").replace(/'/g, "\\'");
                
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #333;">
                        <div style="width: 55%;">
                            <div style="color:white; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${data.title}</div>
                            <div style="font-size:10px; color:#888;">Up b·ªüi: ${data.uploader}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button onclick="openSplitView('${safeTitle}', '${safeUrl}', '${doc.id}', '${data.uploader}')" style="font-size:10px; padding:4px 8px; cursor:pointer; border:1px solid #444; background:transparent; color:#ccc;">Xem</button>
                            <button onclick="approveDocument('${doc.id}')" style="font-size:10px; padding:4px 8px; cursor:pointer; background:var(--neon-blue); color:black; font-weight:bold; border:none;">‚úî Duy·ªát</button>
                            <button onclick="rejectDocument('${doc.id}')" style="font-size:10px; padding:4px 8px; cursor:pointer; background:#FF4500; color:white; border:none;">‚úò X√≥a</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    });
};

// H√†m Duy·ªát (Chuy·ªÉn status -> approved)
window.approveDocument = async function(docId) {
    if (!confirm("X√°c nh·∫≠n DUY·ªÜT t√†i li·ªáu n√†y? N√≥ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã cho to√†n b·ªô Brigade.")) return;
    try {
        await updateDoc(doc(db, "resources", docId), {
            status: 'approved',
            approvedBy: window.currentUserName,
            approvedAt: serverTimestamp()
        });
        window.showNotificationBanner("‚úÖ ƒê√£ duy·ªát t√†i li·ªáu th√†nh c√¥ng!");
    } catch (e) {
        alert("L·ªói: " + e.message);
    }
};

// H√†m T·ª´ ch·ªëi (X√≥a t√†i li·ªáu)
window.rejectDocument = async function(docId) {
    if (!confirm("T·ª´ ch·ªëi v√† X√ìA Vƒ®NH VI·ªÑN t√†i li·ªáu n√†y?")) return;
    try {
        await deleteDoc(doc(db, "resources", docId));
        window.showNotificationBanner("üóëÔ∏è ƒê√£ t·ª´ ch·ªëi v√† x√≥a t√†i li·ªáu.");
    } catch (e) {
        alert("L·ªói: " + e.message);
    }
};
        document.getElementById('auth-msv').addEventListener('keypress', function (e) { if (e.key === 'Enter') window.handleAuth(); });
        document.getElementById('chat-input-field').addEventListener('keypress', function (e) { if (e.key === 'Enter') window.sendMessage(); });
        document.getElementById('void-input-field').addEventListener('keypress', function (e) { if (e.key === 'Enter') window.sendVoidMessage(); }) 
   </script>
</body>
</html>